{"version":3,"sources":["system_browser.js"],"names":["Knex","moment","_","MProject","MSystem","Logger","MCityDistribution","DATE_FORMAT","BASE_TABLE_NAME","TABLE_COLUMN","getTableName","summarySystemBrowser","visitAt","visitAtMonth","unix","format","DATABASE_BY_MONTH","projectList","getList","rawProject","projectId","get","projectName","systemTableName","info","sumRes","count","select","from","where","groupBy","catch","err","error","length","browserVersionRecord","countItem","browser","browser_version","browserVersion","country","province","city","total_count","totalCount","visit_at_month","countAtMonth","distribution","distributionPath","set","browserAndVersion","has","oldCount","newCount","oldDistribution","cityDistribute","mergeDistributionData","newCityRecord","oldCityRecord","item","Object","keys","recordInfo","replaceAndAutoIncreaseBrowserRecord","tableName","updateAt","oldRecordList","andWhere","id","cityDistributeIdInDb","createTimeInDb","data","project_id","count_at_month","update_time","isSuccess","isUpdateSuccess","updateCityDistributionRecord","JSON","stringify","affectRows","update","cityDistributeId","insertCityDistributionRecord","insertResult","returning","insert","into","e","insertId","getRecord","recordList"],"mappings":"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","sourcesContent":["import Knex from '~/src/library/mysql'\nimport moment from 'moment'\nimport _ from 'lodash'\nimport MProject from '~/src/model/project/project'\nimport MSystem from '~/src/model/parse/system'\nimport Logger from '~/src/library/logger'\nimport MCityDistribution from '~/src/model/parse/city_distribution'\nimport DATE_FORMAT from '~/src/constants/date_format'\n\nconst BASE_TABLE_NAME = 't_r_system_browser'\nconst TABLE_COLUMN = [\n  `id`,\n  `project_id`,\n  `browser`,\n  `browser_version`,\n  `total_count`,\n  `count_at_month`,\n  `city_distribute_id`,\n  `create_time`,\n  `update_time`\n]\n\n/**\n * 获取表名\n * @param {number} projectId 项目id\n * @param {number} createTimeAt 创建时间, 时间戳\n * @return {String}\n */\nfunction getTableName() {\n  return BASE_TABLE_NAME\n}\n\nasync function summarySystemBrowser(visitAt) {\n  let visitAtMonth = moment.unix(visitAt).format(DATE_FORMAT.DATABASE_BY_MONTH)\n  const projectList = await MProject.getList()\n  for (let rawProject of projectList) {\n    const projectId = _.get(rawProject, 'id', '')\n    const projectName = _.get(rawProject, 'project_name', '')\n    const systemTableName = MSystem.getTableName(projectId)\n    Logger.info(`开始处理项目${projectId}(${projectName})的数据`)\n    Logger.info(`[${projectId}(${projectName})] 统计月份:${visitAtMonth}`)\n    const sumRes = await Knex\n      .count('* as total_count')\n      .select([`browser`, `browser_version`, `visit_at_month`, `country`, `province`, `city`])\n      .from(systemTableName)\n      .where('visit_at_month', '=', visitAtMonth)\n      .groupBy('browser')\n      .groupBy('browser_version')\n      .groupBy('country')\n      .groupBy('province')\n      .groupBy('city')\n      .catch((err) => {\n        Logger.error(err)\n        return []\n      })\n    if (sumRes.length === 0) {\n      continue\n    }\n    let browserVersionRecord = {}\n    for (let countItem of sumRes) {\n      const { browser, browser_version: browserVersion, country, province, city, total_count: totalCount, visit_at_month: countAtMonth } = countItem\n      let distribution = {}\n      let distributionPath = [country, province, city]\n      _.set(distribution, distributionPath, totalCount)\n      let browserAndVersion = browser + browserVersion\n      if (_.has(browserVersionRecord, browserAndVersion)) {\n        // 若是已经有，更新count/distribution\n        let oldCount = _.get(browserVersionRecord, [browserAndVersion, 'totalCount'], 0)\n        let newCount = oldCount + totalCount\n        let oldDistribution = _.get(browserVersionRecord, [browserAndVersion, 'distribution'], {})\n        let cityDistribute = MCityDistribution.mergeDistributionData(distribution, oldDistribution, (newCityRecord, oldCityRecord) => { return newCityRecord + oldCityRecord })\n        _.set(browserVersionRecord, [browserAndVersion, 'totalCount'], newCount)\n        _.set(browserVersionRecord, [browserAndVersion, 'distribution'], cityDistribute)\n      } else {\n        _.set(browserVersionRecord, [browserAndVersion], {\n          totalCount: totalCount,\n          browser: browser,\n          countAtMonth: countAtMonth,\n          browserVersion: browserVersion,\n          distribution: distribution\n        })\n      }\n    }\n\n    let totalCount = 0\n    for (let item of Object.keys(browserVersionRecord)) {\n      if (item) {\n        totalCount = totalCount + 1\n      }\n      let recordInfo = browserVersionRecord[item]\n      await replaceAndAutoIncreaseBrowserRecord(projectId, recordInfo, recordInfo['distribution'])\n    }\n    Logger.info(`项目${projectId}(${projectName})处理完毕, 共处理${totalCount}条数据`)\n  }\n}\n\n/**\n * 自动创建&更新, 并增加total_count的值\n * @param {number} projectId\n * @param {number} totalCount\n * @param {number} countAtMonth\n * @param {string} countType\n * @param {object} cityDistribute\n * @return {boolean}\n */\nasync function replaceAndAutoIncreaseBrowserRecord(projectId, recordInfo, cityDistribute) {\n  const { totalCount, browser, browserVersion, countAtMonth } = recordInfo\n  if (!browserVersion || !browser || !countAtMonth) {\n    return false\n  }\n  let tableName = getTableName()\n  let updateAt = moment().unix()\n  // 返回值是一个列表\n  let oldRecordList = await Knex\n    .select([`total_count`, `city_distribute_id`, `create_time`, `id`])\n    .from(tableName)\n    .where('project_id', '=', projectId)\n    .andWhere('count_at_month', '=', countAtMonth)\n    .andWhere('browser', '=', browser)\n    .andWhere('browser_version', '=', browserVersion)\n    .catch(() => {\n      return []\n    })\n  // 利用get方法, 不存在直接返回0, 没毛病\n  let id = _.get(oldRecordList, [0, 'id'], 0)\n  let cityDistributeIdInDb = _.get(oldRecordList, [0, 'city_distribute_id'], 0)\n  let createTimeInDb = _.get(oldRecordList, [0, 'create_time'], 0)\n\n  let data = {\n    project_id: projectId,\n    count_at_month: countAtMonth,\n    total_count: totalCount,\n    update_time: updateAt\n  }\n  let isSuccess = false\n  if (id > 0) {\n    // 更新城市分布数据\n    let isUpdateSuccess = MCityDistribution.updateCityDistributionRecord(cityDistributeIdInDb, projectId, createTimeInDb, JSON.stringify(cityDistribute))\n    if (isUpdateSuccess === false) {\n      return false\n    }\n    // 更新具体数据\n    let affectRows = await Knex(tableName)\n      .update(data)\n      .where(`id`, '=', id)\n    isSuccess = affectRows > 0\n  } else {\n    // 首先插入城市分布数据\n    let cityDistributeId = await MCityDistribution.insertCityDistributionRecord(JSON.stringify(cityDistribute), projectId, updateAt)\n    if (cityDistributeId === 0) {\n      // 城市分布数据插入失败\n      return false\n    }\n    data['browser'] = browser\n    data['browser_version'] = browserVersion\n    data['city_distribute_id'] = cityDistributeId\n    data['total_count'] = totalCount\n    data['create_time'] = updateAt\n    let insertResult = await Knex\n      .returning('id')\n      .insert(data)\n      .into(tableName)\n      .catch(e => { return [] })\n    let insertId = _.get(insertResult, [0], 0)\n    isSuccess = insertId > 0\n  }\n  return isSuccess\n}\n\n/**\n * 获取记录\n */\nasync function getRecord(projectId, countAtMonth) {\n  let tableName = getTableName()\n  let recordList = await Knex\n    .select(TABLE_COLUMN)\n    .from(tableName)\n    .where('project_id', '=', projectId)\n    .andWhere('count_at_month', '=', countAtMonth)\n    .catch(() => {\n      return []\n    })\n  return _.get(recordList, [0], {})\n}\n\nexport default {\n  getRecord,\n  summarySystemBrowser\n}\n"],"file":"system_browser.js"}
{"version":3,"sources":["index.js"],"names":["_","dateFns","md5","Logger","MD5_SALT","encodeBase64","content","Buffer","from","toString","decodeBase64","encodeStr","generateChecksum","hash1","parseToken","token","jsonInfo","info","JSON","parse","e","log","checksum","user","ucid","get","name","account","loginAt","generateToken","nickname","getUnixTime","Date","stringify","infoJson"],"mappings":"AAAA,OAAOA,CAAP,MAAc,QAAd;AACA,OAAOC,OAAP,MAAoB,UAApB;AACA,OAAOC,GAAP,MAAgB,KAAhB;AACA,OAAOC,MAAP,MAAmB,sBAAnB;AACA,MAAMC,QAAQ,GAAG,8BAAjB;;AAEA,SAASC,YAAT,CAAuBC,OAAvB,EAAgC;AAC9B,SAAOC,MAAM,CAACC,IAAP,CAAYF,OAAZ,EAAqBG,QAArB,CAA8B,QAA9B,CAAP;AACD;;AAED,SAASC,YAAT,CAAuBC,SAAvB,EAAkC;AAChC,SAAOJ,MAAM,CAACC,IAAP,CAAYG,SAAZ,EAAuB,QAAvB,EAAiCF,QAAjC,EAAP;AACD;;AAED,SAASG,gBAAT,CAA2BN,OAA3B,EAAoC;AAClC,MAAIO,KAAK,GAAGX,GAAG,CAACI,OAAO,GAAGF,QAAX,CAAf;AACA,SAAOF,GAAG,CAACE,QAAQ,GAAGS,KAAZ,CAAV;AACD;AAED;AACA;AACA;AACA;AACA;;;AACA,SAASC,UAAT,CAAqBC,KAArB,EAA4B;AAC1B,MAAIC,QAAQ,GAAGN,YAAY,CAACK,KAAD,CAA3B;AAEA,MAAIE,IAAI,GAAG,EAAX;;AACA,MAAI;AACFA,IAAAA,IAAI,GAAGC,IAAI,CAACC,KAAL,CAAWH,QAAX,CAAP;AACD,GAFD,CAEE,OAAOI,CAAP,EAAU;AACVjB,IAAAA,MAAM,CAACkB,GAAP,CAAW,gBAAX;AACA,WAAO,EAAP;AACD;;AACD,MAAIC,QAAQ,GAAGV,gBAAgB,CAACK,IAAI,CAACM,IAAN,CAA/B;;AACA,MAAID,QAAQ,KAAKL,IAAI,CAACK,QAAtB,EAAgC;AAC9B,WAAO,EAAP;AACD;;AAED,MAAIC,IAAI,GAAGL,IAAI,CAACC,KAAL,CAAWF,IAAI,CAACM,IAAhB,CAAX;;AAEA,MAAIC,IAAI,GAAGxB,CAAC,CAACyB,GAAF,CAAMF,IAAN,EAAY,CAAC,MAAD,CAAZ,EAAsB,CAAtB,CAAX;;AACA,MAAIG,IAAI,GAAG1B,CAAC,CAACyB,GAAF,CAAMF,IAAN,EAAY,CAAC,MAAD,CAAZ,EAAsB,EAAtB,CAAX;;AACA,MAAII,OAAO,GAAG3B,CAAC,CAACyB,GAAF,CAAMF,IAAN,EAAY,CAAC,SAAD,CAAZ,EAAyB,EAAzB,CAAd;;AACA,MAAIK,OAAO,GAAG5B,CAAC,CAACyB,GAAF,CAAMF,IAAN,EAAY,CAAC,SAAD,CAAZ,EAAyB,CAAzB,CAAd;;AACA,SAAO;AACLC,IAAAA,IADK;AAELE,IAAAA,IAFK;AAGLC,IAAAA,OAHK;AAILC,IAAAA;AAJK,GAAP;AAMD;AAED;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASC,aAAT,CAAwBL,IAAxB,EAA8BG,OAA9B,EAAuCG,QAAvC,EAAiD;AAC/C,MAAIF,OAAO,GAAG3B,OAAO,CAAC8B,WAAR,CAAoB,IAAIC,IAAJ,EAApB,CAAd;AACA,MAAIT,IAAI,GAAGL,IAAI,CAACe,SAAL,CAAe;AACxBT,IAAAA,IADwB;AAExBM,IAAAA,QAFwB;AAGxBH,IAAAA,OAHwB;AAIxBC,IAAAA;AAJwB,GAAf,CAAX,CAF+C,CAQ/C;;AACA,MAAIN,QAAQ,GAAGV,gBAAgB,CAACW,IAAD,CAA/B;AACA,MAAIW,QAAQ,GAAGhB,IAAI,CAACe,SAAL,CAAe;AAC5BV,IAAAA,IAD4B;AAE5BD,IAAAA;AAF4B,GAAf,CAAf;AAIA,MAAIL,IAAI,GAAGZ,YAAY,CAAC6B,QAAD,CAAvB;AACA,SAAOjB,IAAP;AACD;;AAED,eAAe;AACbH,EAAAA,UADa;AAEbe,EAAAA;AAFa,CAAf","sourcesContent":["import _ from 'lodash'\nimport dateFns from 'date-fns'\nimport md5 from 'md5'\nimport Logger from '~/src/library/logger'\nconst MD5_SALT = '1111111111111111111111111111'\n\nfunction encodeBase64 (content) {\n  return Buffer.from(content).toString('base64')\n}\n\nfunction decodeBase64 (encodeStr) {\n  return Buffer.from(encodeStr, 'base64').toString()\n}\n\nfunction generateChecksum (content) {\n  let hash1 = md5(content + MD5_SALT)\n  return md5(MD5_SALT + hash1)\n}\n\n/**\n * 解析cookie中的token字段, 返回用户信息, 没有登录返回空对象\n * @param {Object} cookie\n * @return {Object}\n */\nfunction parseToken (token) {\n  let jsonInfo = decodeBase64(token)\n\n  let info = {}\n  try {\n    info = JSON.parse(jsonInfo)\n  } catch (e) {\n    Logger.log('info信息不是标准json')\n    return {}\n  }\n  let checksum = generateChecksum(info.user)\n  if (checksum !== info.checksum) {\n    return {}\n  }\n\n  let user = JSON.parse(info.user)\n\n  let ucid = _.get(user, ['ucid'], 0)\n  let name = _.get(user, ['name'], '')\n  let account = _.get(user, ['account'], '')\n  let loginAt = _.get(user, ['loginAt'], 0)\n  return {\n    ucid,\n    name,\n    account,\n    loginAt\n  }\n}\n\n/**\n * 生成 cookie token\n * @param {*} ucid\n * @param {*} nickname\n * @param {*} account\n * @return {String}\n */\nfunction generateToken (ucid, account, nickname) {\n  let loginAt = dateFns.getUnixTime(new Date())\n  let user = JSON.stringify({\n    ucid,\n    nickname,\n    account,\n    loginAt\n  })\n  // 利用checksum和loginAt避免登录信息被篡改\n  let checksum = generateChecksum(user)\n  let infoJson = JSON.stringify({\n    user,\n    checksum\n  })\n  let info = encodeBase64(infoJson)\n  return info\n}\n\nexport default {\n  parseToken,\n  generateToken\n}\n"],"file":"index.js"}
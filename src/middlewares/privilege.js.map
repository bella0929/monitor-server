{"version":3,"sources":["privilege.js"],"names":["_","Auth","API_RES","MProjectMember","Logger","appendUserInfo","req","res","next","cookies","token","get","user","parseToken","set","appendProjectInfo","path","startsWith","projectId","parseInt","split","checkLogin","ucid","log","send","needLoginIn","checkPrivilege","hasPrivilege","noPrivilege"],"mappings":"AAAA,OAAOA,CAAP,MAAc,QAAd;AACA,OAAOC,IAAP,MAAiB,oBAAjB;AACA,OAAOC,OAAP,MAAoB,yBAApB;AACA,OAAOC,cAAP,MAA2B,oCAA3B;AACA,OAAOC,MAAP,MAAmB,sBAAnB;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,SAASC,cAAT,CAAyBC,GAAzB,EAA8BC,GAA9B,EAAmCC,IAAnC,EAAyC;AACvC,MAAIC,OAAO,GAAGH,GAAG,CAACG,OAAlB;;AACA,MAAIC,KAAK,GAAGV,CAAC,CAACW,GAAF,CAAMF,OAAN,EAAe,CAAC,WAAD,CAAf,EAA8B,EAA9B,CAAZ;;AACA,MAAIG,IAAI,GAAGX,IAAI,CAACY,UAAL,CAAgBH,KAAhB,CAAX,CAHuC,CAIvC;;AACAV,EAAAA,CAAC,CAACc,GAAF,CAAMR,GAAN,EAAW,CAAC,KAAD,EAAQ,MAAR,CAAX,EAA4BM,IAA5B;;AACAJ,EAAAA,IAAI;AACL;AAED;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASO,iBAAT,CAA4BT,GAA5B,EAAiCC,GAAjC,EAAsCC,IAAtC,EAA4C;AAC1C,MAAIQ,IAAI,GAAGV,GAAG,CAACU,IAAf;;AACA,MAAIhB,CAAC,CAACiB,UAAF,CAAaD,IAAb,EAAmB,UAAnB,CAAJ,EAAoC;AAClC,QAAIE,SAAS,GAAGC,QAAQ,CAACnB,CAAC,CAACW,GAAF,CAAMK,IAAI,CAACI,KAAL,CAAW,GAAX,CAAN,EAAuB,CAAC,CAAD,CAAvB,EAA4B,CAA5B,CAAD,CAAxB;;AACApB,IAAAA,CAAC,CAACc,GAAF,CAAMR,GAAN,EAAW,CAAC,KAAD,EAAQ,SAAR,EAAmB,WAAnB,CAAX,EAA4CY,SAA5C;AACD;;AACDV,EAAAA,IAAI;AACL;AAED;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASa,UAAT,CAAqBf,GAArB,EAA0BC,GAA1B,EAA+BC,IAA/B,EAAqC;AACnC,MAAIc,IAAI,GAAGtB,CAAC,CAACW,GAAF,CAAML,GAAN,EAAW,CAAC,KAAD,EAAQ,MAAR,EAAgB,MAAhB,CAAX,EAAoC,CAApC,CAAX;;AACA,MAAIgB,IAAI,KAAK,CAAb,EAAgB;AACdlB,IAAAA,MAAM,CAACmB,GAAP,CAAW,MAAX;AACAhB,IAAAA,GAAG,CAACiB,IAAJ,CAAStB,OAAO,CAACuB,WAAR,EAAT;AACA;AACD;;AACDjB,EAAAA,IAAI;AACL;AAED;AACA;AACA;AACA;AACA;AACA;;;AACA,eAAekB,cAAf,CAA+BpB,GAA/B,EAAoCC,GAApC,EAAyCC,IAAzC,EAA+C;AAC7C,MAAIc,IAAI,GAAGtB,CAAC,CAACW,GAAF,CAAML,GAAN,EAAW,CAAC,KAAD,EAAQ,MAAR,EAAgB,MAAhB,CAAX,EAAoC,CAApC,CAAX;;AACA,MAAIY,SAAS,GAAGlB,CAAC,CAACW,GAAF,CAAML,GAAN,EAAW,CAAC,KAAD,EAAQ,SAAR,EAAmB,WAAnB,CAAX,EAA4C,CAA5C,CAAhB,CAF6C,CAG7C;;;AACA,MAAIqB,YAAY,GAAG,MAAMxB,cAAc,CAACwB,YAAf,CAA4BT,SAA5B,EAAuCI,IAAvC,CAAzB;;AACA,MAAIK,YAAY,KAAK,KAArB,EAA4B;AAC1BvB,IAAAA,MAAM,CAACmB,GAAP,CAAW,QAAX;AACAhB,IAAAA,GAAG,CAACiB,IAAJ,CAAStB,OAAO,CAAC0B,WAAR,EAAT;AACA;AACD;;AACDpB,EAAAA,IAAI;AACL;;AAED,eAAe;AACbO,EAAAA,iBADa;AAEbV,EAAAA,cAFa;AAGbgB,EAAAA,UAHa;AAIbK,EAAAA;AAJa,CAAf","sourcesContent":["import _ from 'lodash'\nimport Auth from '~/src/library/auth'\nimport API_RES from '~/src/constants/api_res'\nimport MProjectMember from '~/src/model/project/project_member'\nimport Logger from '~/src/library/logger'\n/**\n * 将用户信息更新到req对象中\n * @param {*} req\n * @param {*} res\n * @param {*} next\n */\nfunction appendUserInfo (req, res, next) {\n  let cookies = req.cookies\n  let token = _.get(cookies, ['fee_token'], '')\n  let user = Auth.parseToken(token)\n  // 将用户信息添加到req.fee中(只添加信息, 在check里在检查是否需要登录)\n  _.set(req, ['fee', 'user'], user)\n  next()\n}\n\n/**\n * 将projectId添加到req.fee中, 只添加数据, 在check中再检查权限\n * @param {*} req\n * @param {*} res\n * @param {*} next\n */\nfunction appendProjectInfo (req, res, next) {\n  let path = req.path\n  if (_.startsWith(path, '/project')) {\n    let projectId = parseInt(_.get(path.split('/'), [2], 0))\n    _.set(req, ['fee', 'project', 'projectId'], projectId)\n  }\n  next()\n}\n\n/**\n * 检查用户是否已登录\n * @param {*} req\n * @param {*} res\n * @param {*} next\n */\nfunction checkLogin (req, res, next) {\n  let ucid = _.get(req, ['fee', 'user', 'ucid'], 0)\n  if (ucid === 0) {\n    Logger.log('没有登录')\n    res.send(API_RES.needLoginIn())\n    return\n  }\n  next()\n}\n\n/**\n * 检查用户是否拥有该项目权限\n * @param {*} req\n * @param {*} res\n * @param {*} next\n */\nasync function checkPrivilege (req, res, next) {\n  let ucid = _.get(req, ['fee', 'user', 'ucid'], 0)\n  let projectId = _.get(req, ['fee', 'project', 'projectId'], 0)\n  // 查询数据库\n  let hasPrivilege = await MProjectMember.hasPrivilege(projectId, ucid)\n  if (hasPrivilege === false) {\n    Logger.log('没有项目权限')\n    res.send(API_RES.noPrivilege())\n    return\n  }\n  next()\n}\n\nexport default {\n  appendProjectInfo,\n  appendUserInfo,\n  checkLogin,\n  checkPrivilege\n}\n"],"file":"privilege.js"}
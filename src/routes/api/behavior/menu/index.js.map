{"version":3,"sources":["index.js"],"names":["moment","DATE_FORMAT","MBehaviorDistribution","API_RES","RouterConfigBuilder","_","REQUEST_DATE_TYPE","clickSummaryConfig","routerConfigBuilder","METHOD_TYPE_GET","req","res","projectId","get","startAtMoment","format","subtract","endAtMoment","clone","add","rawRecordList","getRecordList","unix","UNIT","DAY","clickDistribution","rawRecord","menuCode","totalCount","menuUrl","menuName","oldTotalCount","has","set","recordList","objectKey","Object","keys","clickDetail","push","send","showResult","err","showError","message"],"mappings":"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","sourcesContent":["import moment from 'moment'\nimport DATE_FORMAT from '~/src/constants/date_format'\n\nimport MBehaviorDistribution from '~/src/model/parse/behavior_distribution'\nimport API_RES from '~/src/constants/api_res'\nimport RouterConfigBuilder from '~/src/library/utils/modules/router_config_builder'\nimport _ from 'lodash'\n\nconst REQUEST_DATE_TYPE = 'YYYY-MM-DD 00:00:00'\n\n/**\n * 只有按星期分布这一种情况\n */\nlet clickSummaryConfig = RouterConfigBuilder.routerConfigBuilder('/api/behavior/menu', RouterConfigBuilder.METHOD_TYPE_GET, async (req, res) => {\n  let projectId = _.get(req, ['fee', 'project', 'projectId'], 0)\n  let startAtMoment = moment(moment().format(REQUEST_DATE_TYPE), REQUEST_DATE_TYPE).subtract(7, 'days')\n  let endAtMoment = startAtMoment.clone().add(7, 'days') // 取最近七天的数据\n\n  let rawRecordList = await MBehaviorDistribution.getRecordList(projectId, startAtMoment.unix(), endAtMoment.unix(), DATE_FORMAT.UNIT.DAY)\n  let clickDistribution = {}\n  for (let rawRecord of rawRecordList) {\n    let menuCode = _.get(rawRecord, 'code', 0)\n    let totalCount = _.get(rawRecord, 'total_count', 0)\n    let menuUrl = _.get(rawRecord, 'url', '')\n    let menuName = _.get(rawRecord, 'name', 0)\n    if (menuCode === '' || menuCode === 0 || menuUrl === '') {\n      continue\n    }\n    let oldTotalCount = 0\n    if (_.has(clickDistribution, menuCode)) {\n      oldTotalCount = _.get(clickDistribution, [menuCode, 'totalCount'], 0)\n    }\n    totalCount = totalCount + oldTotalCount\n    _.set(clickDistribution, [menuCode], { menuCode, menuName, menuUrl, totalCount })\n  }\n\n  let recordList = []\n  for (let objectKey of Object.keys(clickDistribution)) {\n    let clickDetail = clickDistribution[objectKey]\n    recordList.push({\n      ...clickDetail\n    })\n  }\n\n  try {\n    res.send(API_RES.showResult(recordList))\n  } catch (err) {\n    res.send(API_RES.showError(err.message))\n  }\n})\n\nexport default {\n  ...clickSummaryConfig\n}\n"],"file":"index.js"}
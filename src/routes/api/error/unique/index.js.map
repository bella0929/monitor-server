{"version":3,"sources":["index.js"],"names":["moment","_","MMonitor","DATE_FORMAT","API_RES","RouterConfigBuilder","MErrorSummary","PROVINCE_LIST","PAGE_SIZE","MAX_URL","parseQueryParam","request","projectId","get","startAt","endAt","url","currentPage","errorNameListJson","errorNameList","JSON","parse","error","startOf","UNIT","DAY","unix","endOf","parseResult","getErrorDistribution","routerConfigBuilder","METHOD_TYPE_GET","req","res","errorList","getErrorNameDistributionInLast7DayWithCache","send","showResult","getErrorLogList","offset","errorCount","getTotalCountByConditionInSameMonth","getListByConditionInSameMonth","pageData","pager","current_page","page_size","total","list","getUrlDistribution","countType","rawDistributionList","getUrlPathDistributionListByErrorNameList","distributionList","rawDistribution","url_path","error_count","record","name","value","push","getErrorNameList","getErrorNameDistributionListInSameMonth","error_name","errorName","distribution","getGeographyDistribution","rawRecordList","getList","resultList","distributionMap","rawRecord","cityDistribution","country","Object","keys","provinceMap","province","cityMap","city","has","sort","a","b"],"mappings":"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","sourcesContent":["import moment from 'moment'\nimport _ from 'lodash'\nimport MMonitor from '~/src/model/parse/monitor'\nimport DATE_FORMAT from '~/src/constants/date_format'\nimport API_RES from '~/src/constants/api_res'\nimport RouterConfigBuilder from '~/src/library/utils/modules/router_config_builder'\nimport MErrorSummary from '~/src/model/summary/error_summary'\n// import Viser from '~/src/routes/api/error/viser'\nimport PROVINCE_LIST from '~/src/constants/province'\n\nconst PAGE_SIZE = 10\nconst MAX_URL = 10\n\n/**\n * 提供一个方法, 集中解析request参数\n * @param {*} request\n */\nfunction parseQueryParam (request) {\n  let projectId = _.get(request, ['fee', 'project', 'projectId'], 0)\n  let startAt = _.get(request, ['query', 'start_at'], 0)\n  let endAt = _.get(request, ['query', 'end_at'], 0)\n  let url = _.get(request, ['query', 'url'], '')\n  let currentPage = _.get(request, ['query', 'current_page'], 1)\n  let errorNameListJson = _.get(request, ['query', 'error_name_list_json'], '[]')\n  let errorNameList = []\n  try {\n    errorNameList = JSON.parse(errorNameListJson)\n  } catch (error) {\n    errorNameList = []\n  }\n\n  // 提供默认值\n  if (startAt <= 0) {\n    startAt = moment().startOf(DATE_FORMAT.UNIT.DAY).unix()\n  }\n  if (endAt <= 0) {\n    endAt = moment().endOf(DATE_FORMAT.UNIT.DAY).unix()\n  }\n\n  let parseResult = {\n    projectId,\n    startAt,\n    endAt,\n    url,\n    currentPage,\n    errorNameList\n  }\n  return parseResult\n}\n\nlet getErrorDistribution = RouterConfigBuilder.routerConfigBuilder('/api/error/distribution/summary', RouterConfigBuilder.METHOD_TYPE_GET, async (req, res) => {\n  const projectId = _.get(req, ['fee', 'project', 'projectId'], 0)\n\n  let errorList = await MErrorSummary.getErrorNameDistributionInLast7DayWithCache(projectId)\n\n  res.send(API_RES.showResult(errorList))\n})\n\n/**\n * 错误日志\n */\nlet getErrorLogList = RouterConfigBuilder.routerConfigBuilder('/api/error/log/list', RouterConfigBuilder.METHOD_TYPE_GET, async (req, res) => {\n  let parseResult = parseQueryParam(req)\n  let {\n    projectId,\n    errorNameList,\n    startAt,\n    endAt,\n    url,\n    currentPage\n  } = parseResult\n  const offset = (currentPage - 1) * PAGE_SIZE\n\n  let errorCount = await MMonitor.getTotalCountByConditionInSameMonth(projectId, startAt, endAt, offset, PAGE_SIZE, errorNameList, url)\n  let errorList = await MMonitor.getListByConditionInSameMonth(projectId, startAt, endAt, offset, PAGE_SIZE, errorNameList, url)\n\n  let pageData = {\n    pager: {\n      current_page: currentPage,\n      page_size: PAGE_SIZE,\n      total: errorCount\n    },\n    list: errorList\n  }\n\n  res.send(API_RES.showResult(pageData))\n})\n\n/**\n * url分布数\n */\nlet getUrlDistribution = RouterConfigBuilder.routerConfigBuilder('/api/error/distribution/url', RouterConfigBuilder.METHOD_TYPE_GET, async (req, res) => {\n  let parseResult = parseQueryParam(req)\n  let {\n    projectId,\n    startAt,\n    endAt,\n    errorNameList\n  } = parseResult\n  let countType = DATE_FORMAT.UNIT.DAY\n\n  let rawDistributionList = await MErrorSummary.getUrlPathDistributionListByErrorNameList(projectId, startAt, endAt, errorNameList, countType, MAX_URL)\n  let distributionList = []\n  for (let rawDistribution of rawDistributionList) {\n    let { url_path: url, error_count: errorCount } = rawDistribution\n    let record = {\n      name: url,\n      value: errorCount\n    }\n    distributionList.push(record)\n  }\n  res.send(API_RES.showResult(distributionList))\n})\n\n// 指定error_name分布数\nlet getErrorNameList = RouterConfigBuilder.routerConfigBuilder('/api/error/distribution/error_name', RouterConfigBuilder.METHOD_TYPE_GET, async (req, res) => {\n  let parseResult = parseQueryParam(req)\n  let {\n    projectId,\n    startAt,\n    endAt,\n    url,\n    errorNameList\n  } = parseResult\n\n  let countType = DATE_FORMAT.UNIT.DAY\n\n  let rawDistributionList = await MErrorSummary.getErrorNameDistributionListInSameMonth(projectId, startAt, endAt, countType, errorNameList, url)\n  let distributionList = []\n  for (let rawDistribution of rawDistributionList) {\n    let { error_count: errorCount, error_name: errorName } = rawDistribution\n    let distribution = {\n      name: errorName,\n      value: errorCount\n    }\n    distributionList.push(distribution)\n  }\n  res.send(API_RES.showResult(distributionList))\n})\n\nlet getGeographyDistribution = RouterConfigBuilder.routerConfigBuilder('/api/error/distribution/geography', RouterConfigBuilder.METHOD_TYPE_GET, async (req, res) => {\n  let parseResult = parseQueryParam(req)\n  let {\n    projectId,\n    startAt,\n    endAt,\n    url,\n    errorNameList\n  } = parseResult\n\n  let countType = DATE_FORMAT.UNIT.DAY\n\n  const rawRecordList = await MErrorSummary.getList(projectId, startAt, endAt, countType, errorNameList, url)\n  let resultList = []\n  let distributionMap = {}\n\n  for (let rawRecord of rawRecordList) {\n    let cityDistribution = _.get(rawRecord, ['city_distribution'], {})\n    // 按省份进行统计\n    for (let country of Object.keys(cityDistribution)) {\n      let provinceMap = _.get(cityDistribution, [country], {})\n      for (let province of Object.keys(provinceMap)) {\n        let cityMap = _.get(provinceMap, [province], {})\n        for (let city of Object.keys(cityMap)) {\n          let errorCount = _.get(cityMap, [city], 0)\n          if (_.has(distributionMap, [province])) {\n            distributionMap[province] = distributionMap[province] + errorCount\n          } else {\n            distributionMap[province] = errorCount\n          }\n        }\n      }\n    }\n  }\n  // 只显示国内省份\n  for (let province of PROVINCE_LIST) {\n    let errorCount = _.get(distributionMap, [province], 0)\n    resultList.push({\n      name: province,\n      value: errorCount\n    })\n  }\n  resultList.sort((a, b) => b['value'] - a['value'])\n  res.send(API_RES.showResult(resultList))\n})\n\nexport default {\n  ...getErrorLogList,\n  ...getUrlDistribution,\n\n  ...getErrorNameList,\n  ...getGeographyDistribution,\n  ...getErrorDistribution\n}\n"],"file":"index.js"}